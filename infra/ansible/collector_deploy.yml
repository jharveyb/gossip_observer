- name: Deploy collector dependencies (no restart)
  hosts: collectors
  become: true

  pre_tasks:
    - name: Load vault variables
      ansible.builtin.include_vars: vault.yml

    - name: Validate collector configuration
      ansible.builtin.import_tasks: tasks/validate_collectors.yml

  tasks:
    - name: Filter collectors for this host
      ansible.builtin.set_fact:
        host_collectors: "{{ gossip_collectors | selectattr('host', 'equalto', inventory_hostname) | list }}"

    - name: Skip host if no collectors assigned
      ansible.builtin.meta: end_host
      when: host_collectors | length == 0

    - name: Check Tailscale is available
      ansible.builtin.fail:
        msg: "Tailscale interface (tailscale0) not found. Ensure Tailscale is installed and running."
      when: ansible_facts['tailscale0'] is not defined

    - name: Get Tailscale IP address
      ansible.builtin.set_fact:
        tailscale_ip: "{{ ansible_facts['tailscale0']['ipv4']['address'] }}"

    - name: Deploy collector dependencies
      ansible.builtin.import_tasks: tasks/collector_deploy_deps.yml
